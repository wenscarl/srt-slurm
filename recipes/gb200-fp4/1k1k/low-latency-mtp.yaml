# This script requires a custom branch for running, please launch as follows:
name: "gb200-fp4-1k1k-low-latency-0p5p8"

dynamo:
  version: 0.8.1

frontend:
  type: dynamo
  enable_multiple_frontends: true
  num_additional_frontends: 3

model:
  path: "dsfp4"
  container: "lmsysorg/sglang:v0.5.8-cu130"
  precision: "fp4"

resources:
  gpu_type: "gb200"
  prefill_nodes: 1
  decode_nodes: 2
  prefill_workers: 1
  decode_workers: 2
  gpus_per_node: 4

backend:

  prefill_environment:
    TORCH_DISTRIBUTED_DEFAULT_TIMEOUT: "1800"
    PYTHONUNBUFFERED: "1"
    SGLANG_JIT_DEEPGEMM_FAST_WARMUP: "1"
    DYN_SKIP_SGLANG_LOG_FORMATTING: "1"
    SGLANG_USE_MESSAGE_QUEUE_BROADCASTER: "0"
    SGLANG_DISABLE_TP_MEMORY_INBALANCE_CHECK: "1"
    SGLANG_DISAGGREGATION_HEARTBEAT_MAX_FAILURE: "100000"
    SGLANG_DISAGGREGATION_BOOTSTRAP_TIMEOUT: "100000"
    SGLANG_DISAGGREGATION_WAITING_TIMEOUT: "100000"
    SGLANG_DECODE_BOOTSTRAP_TIMEOUT: "1000"
    MC_FORCE_MNNVL: "1"
    NCCL_MNNVL_ENABLE: "1"
    NCCL_CUMEM_ENABLE: "1"
    SGLANG_MOONCAKE_CUSTOM_MEM_POOL: "True"
#    SGLANG_ENABLE_JIT_DEEPGEMM: "false"
    SGLANG_ENABLE_SPEC_V2: "1"
  #  SGLANG_NVFP4_CKPT_FP8_NEXTN_MOE: "1"

  decode_environment:
    SGLANG_JIT_DEEPGEMM_FAST_WARMUP: "1"
    TORCH_DISTRIBUTED_DEFAULT_TIMEOUT: "1800"
    PYTHONUNBUFFERED: "1"
    DYN_SKIP_SGLANG_LOG_FORMATTING: "1"
    SGLANG_USE_MESSAGE_QUEUE_BROADCASTER: "0"
    SGLANG_DISABLE_TP_MEMORY_INBALANCE_CHECK: "1"
    SGLANG_DISAGGREGATION_HEARTBEAT_MAX_FAILURE: "100000"
    SGLANG_DISAGGREGATION_BOOTSTRAP_TIMEOUT: "100000"
    SGLANG_DISAGGREGATION_WAITING_TIMEOUT: "100000"
    SGLANG_DECODE_BOOTSTRAP_TIMEOUT: "1000"
    MC_FORCE_MNNVL: "1"
    NCCL_MNNVL_ENABLE: "1"
    NCCL_CUMEM_ENABLE: "1"
    SGLANG_MOONCAKE_CUSTOM_MEM_POOL: "True"
 #   SGLANG_ENABLE_JIT_DEEPGEMM: "false"
    SGLANG_ENABLE_SPEC_V2: "1"
 #   SGLANG_NVFP4_CKPT_FP8_NEXTN_MOE: "1"

  sglang_config:
    prefill:
      disaggregation-mode: "prefill"
      model-path: "/model/"
      served-model-name: "deepseek-ai/DeepSeek-R1"
      trust-remote-code: true
      disable-radix-cache: true
      kv-cache-dtype: "fp8_e4m3"
      attention-backend: "trtllm_mla"
      quantization: "modelopt_fp4"
      moe-runner-backend: "flashinfer_trtllm"
      stream-interval: 10
      watchdog-timeout: 1000000
      context-length: 2200
      mem-fraction-static: 0.95
      max-total-tokens: 8192
      chunked-prefill-size: 8192
      cuda-graph-max-bs: 256
      max-running-requests: 512
      scheduler-recv-interval: 10
      enable-symm-mem: true
      moe-dense-tp-size: 1
      load-balance-method: "round_robin"
      disaggregation-bootstrap-port: 30001
      disaggregation-transfer-backend: nixl
      fp4-gemm-backend: "flashinfer_trtllm"
      data-parallel-size: 1
      tensor-parallel-size: 4
      expert-parallel-size: 1
      speculative-algorithm: "EAGLE"
      speculative-num-steps: 2
      speculative-eagle-topk: 1
      speculative-num-draft-tokens: 3
    #  speculative-moe-runner-backend: "deep_gemm"
    #  speculative-moe-a2a-backend: "deepep"

    decode:
      disaggregation-mode: "decode"
      model-path: "/model/"
      served-model-name: "deepseek-ai/DeepSeek-R1"
      prefill-round-robin-balance: true
      trust-remote-code: true
      disable-radix-cache: true
      kv-cache-dtype: "fp8_e4m3"
      attention-backend: "trtllm_mla"
      quantization: "modelopt_fp4"
      moe-runner-backend: "flashinfer_trtllm"
      disaggregation-bootstrap-port: 30001
      stream-interval: 10
      watchdog-timeout: 1000000
      context-length: 2200
      mem-fraction-static: 0.85
      chunked-prefill-size: 8192
      cuda-graph-max-bs: 256
      scheduler-recv-interval: 10
      enable-symm-mem: true
      moe-dense-tp-size: 1
      disaggregation-transfer-backend: nixl
      fp4-gemm-backend: "flashinfer_trtllm"
      tensor-parallel-size: 4
      expert-parallel-size: 1
      speculative-algorithm: "EAGLE"
      speculative-num-steps: 2
      speculative-eagle-topk: 1
      speculative-num-draft-tokens: 3
   #   speculative-moe-runner-backend: "deep_gemm"
   #   speculative-moe-a2a-backend: "deepep"

benchmark:
  type: "sa-bench"
  isl: 1024
  osl: 1024
  concurrencies: "4x8x32x64x112x128x256"
  req_rate: "inf"
